# 24ï½œSynchronizedï¼šåŒæ­¥é”çš„åŽŸç†åŠåº”ç”¨
ä½ å¥½ï¼Œæˆ‘æ˜¯åº·æ¨ã€‚

Java ä¸­çš„åŒæ­¥é”æœºåˆ¶æ˜¯ Java å¹¶å‘ç¼–ç¨‹çš„åŸºç¡€ï¼Œå®ƒå¯ä»¥ä¿è¯åœ¨å¤šçº¿ç¨‹çŽ¯å¢ƒä¸‹å¯¹å…±äº«èµ„æºçš„äº’æ–¥è®¿é—®ã€‚åœ¨ Java ä¸­ï¼ŒåŒæ­¥é”æœºåˆ¶ä¸»è¦ç”± Synchronized å…³é”®å­—å®žçŽ°ã€‚ä»Šå¤©æˆ‘å°†è¯¦ç»†èŠä¸€èŠåŒæ­¥é”çš„åŽŸç†ï¼Œä»¥åŠåœ¨ JDK æºç ä¸­çš„åº”ç”¨ï¼Œå¹¶ç»™å‡ºæœ€ä½³å®žè·µã€‚

## é”çš„çŠ¶æ€ä¸Žç±»åž‹

Synchronizedæ˜¯Javaä¸­æœ€å…·ä»£è¡¨æ€§çš„äº’æ–¥åŒæ­¥æ‰‹æ®µä¹‹ä¸€ï¼Œå®ƒåœ¨åº•å±‚å®žçŽ°ä¸Šå¹¶ä¸ä¾èµ–äºŽLockæŽ¥å£åŠå…¶å®žçŽ°ç±»ã€‚Synchronized æ‰€ä¾èµ–çš„æ˜¯JVMå†…éƒ¨çš„ç›‘è§†å™¨é”ï¼ˆmonitorï¼‰ã€‚åœ¨ç«žäº‰ç¨‹åº¦è¾ƒä½Žçš„åœºæ™¯ä¸‹ï¼ŒSynchronized å¯ä»¥æä¾›è¾ƒé«˜çš„æ€§èƒ½ã€‚åœ¨JVMå¯¹Synchronizedè¿›è¡Œä¼˜åŒ–åŽï¼Œå¦‚ä½¿ç”¨åå‘é”ã€è½»é‡çº§é”ç­‰ï¼Œèƒ½ä½¿å…¶åœ¨æ— ç«žäº‰å’Œè½»åº¦ç«žäº‰æƒ…å†µä¸‹é¿å…é‡é‡çº§é”ä½¿ç”¨æ“ä½œç³»ç»Ÿäº’æ–¥é‡å¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—ã€‚

Synchronized å±žäºŽ JVM çš„å†…ç½®é”ï¼ŒSynchronized æ–¹æ³•æˆ–ä»£ç å—åœ¨ç¼–è¯‘åŽï¼Œä¼šåœ¨å­—èŠ‚ç å±‚é¢æœ‰ä¸€å¯¹ **monitorenter å’Œ monitorexit æŒ‡ä»¤ï¼Œåˆ†åˆ«è¡¨ç¤ºèŽ·å–é”å’Œé‡Šæ”¾é”**ã€‚

å½“ä¸€ä¸ªçº¿ç¨‹è¯•å›¾èŽ·å–æŸä¸ªå¯¹è±¡çš„ç›‘è§†å™¨ï¼ˆä¹Ÿå«åšç›‘æŽ§é”æˆ–åŒæ­¥é”ï¼‰æ—¶ï¼Œå®ƒä¼šæ‰§è¡Œ monitorenter æŒ‡ä»¤ã€‚è¿™ä¸ªæŒ‡ä»¤ä¼šæŠŠå¯¹è±¡å¼•ç”¨åŠ è½½åˆ°æ“ä½œæ•°æ ˆä¸­ï¼Œç„¶åŽå°è¯•èŽ·å–è¿™ä¸ªå¯¹è±¡æ‰€æŒ‡å‘çš„å¯¹è±¡çš„é”ã€‚å¦‚æžœèŽ·å–æˆåŠŸï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°†æˆä¸ºè¯¥å¯¹è±¡çš„æ‰€æœ‰è€…ï¼Œå…¶ä»–çº¿ç¨‹å¿…é¡»ç­‰å¾…é”è¢«é‡Šæ”¾æ‰èƒ½èŽ·å–ã€‚å½“çº¿ç¨‹é€€å‡ºåŒæ­¥ä»£ç å—æˆ–è°ƒç”¨ wait() æ–¹æ³•æ—¶ï¼Œmonitorexit æŒ‡ä»¤è´Ÿè´£é‡Šæ”¾é”ã€‚

### é”çš„çŠ¶æ€åŠ JVM è§†è§’

ä»Ž JVM çš„è§’åº¦æ¥çœ‹ï¼Œé”çš„çŠ¶æ€å¯ä»¥åˆ†ä¸º 0ã€1ã€2ã€3 å››ç§ï¼Œåˆ†åˆ«è¡¨ç¤ºæ— é”çŠ¶æ€ã€åå‘é”çŠ¶æ€ã€è½»é‡çº§é”çŠ¶æ€å’Œé‡é‡çº§é”çŠ¶æ€ã€‚è¿™äº›çŠ¶æ€åæ˜ äº†é”çš„ä¸åŒç«žäº‰ç¨‹åº¦å’Œæ€§èƒ½ç‰¹ç‚¹ã€‚é”è¿˜æœ‰ä¸€ä¸ªè®¡æ•°å™¨ï¼Œç”¨äºŽè®°å½•çº¿ç¨‹è¿›å…¥åŒæ­¥å—çš„å±‚æ•°ã€‚

### é”çš„ç±»åž‹

Java ä¸­çš„é”ä¸»è¦åˆ†ä¸ºä¸‰ç§ï¼šåå‘é”ã€è½»é‡çº§é”å’Œé‡é‡çº§é”ã€‚è¿™ä¸‰ç§é”åœ¨ä¸åŒçš„åœºæ™¯ä¸‹å…·æœ‰ä¸åŒçš„æ€§èƒ½ç‰¹ç‚¹ã€‚

- åå‘é”ï¼šåå‘é”æ˜¯ä¸€ç§é’ˆå¯¹å•çº¿ç¨‹è®¿é—®çš„ä¼˜åŒ–æ‰‹æ®µã€‚å½“ä¸€ä¸ªçº¿ç¨‹é¦–æ¬¡è®¿é—®æŸä¸ªå¯¹è±¡æ—¶ï¼Œåå‘é”ä¼šå°è¯•èŽ·å–è¯¥å¯¹è±¡çš„é”ã€‚å¦‚æžœåŽç»­çš„è®¿é—®ä»ç„¶æ˜¯è¿™ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆåå‘é”å°±ä¸éœ€è¦å†æ¬¡èŽ·å–é”ï¼Œä»Žè€Œå‡å°‘äº†é”çš„ç«žäº‰å¼€é”€ã€‚
- è½»é‡çº§é”ï¼šä¸»è¦é’ˆå¯¹å¤šçº¿ç¨‹è®¿é—®çš„åœºæ™¯ã€‚å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®æŸä¸ªå¯¹è±¡æ—¶ï¼Œè½»é‡çº§é”é€šè¿‡è‡ªæ—‹ç­‰å¾…çš„æ–¹å¼å®žçŽ°é”çš„èŽ·å–ï¼Œä»¥é™ä½Žçº¿ç¨‹çš„é˜»å¡žç¨‹åº¦ã€‚
- é‡é‡çº§é”ï¼šé‡é‡çº§é”æ˜¯ä¸€ç§æ¯”è¾ƒä¼ ç»Ÿçš„é”ä¼˜åŒ–æ‰‹æ®µï¼Œå®ƒåœ¨é”çš„ç«žäº‰æ¿€çƒˆæ—¶èƒ½å¤Ÿæä¾›æ›´å¥½çš„æ€§èƒ½ã€‚å½“è½»é‡çº§é”çš„è‡ªæ—‹ç­‰å¾…æ—¶é—´è¶…è¿‡ä¸€å®šé˜ˆå€¼æ—¶ï¼Œé”ä¼šå‡çº§ä¸ºé‡é‡çº§é”ã€‚

### é”çš„çŠ¶æ€åŠç‰¹ç‚¹

é”çš„çŠ¶æ€å¯ä»¥åˆ†ä¸ºå››ç§ï¼šæ— é”çŠ¶æ€ï¼ˆUnlockedï¼‰ã€åå‘é”çŠ¶æ€ï¼ˆMonitor é”ï¼‰ã€è½»é‡çº§é”çŠ¶æ€ï¼ˆLock é”ï¼‰ï¼Œä»¥åŠä¸€ç§é‡é‡çº§é”çŠ¶æ€ï¼ˆHeavyweight Lockï¼‰ã€‚

#### æ— é”çŠ¶æ€

åœ¨æ— é”çŠ¶æ€ä¸‹ï¼Œçº¿ç¨‹å¯ä»¥è‡ªç”±åœ°è®¿é—®å…±äº«èµ„æºï¼Œæ— éœ€è¿›è¡ŒåŒæ­¥ã€‚åœ¨æ­¤çŠ¶æ€ä¸‹ï¼ŒMark Wordçš„å†…å®¹æ˜¯å¯¹è±¡çš„å“ˆå¸Œç ï¼ˆHashCodeï¼‰, GCåˆ†ä»£å¹´é¾„å’Œé”æ ‡å¿—ä½æ˜¯01ã€‚å…¶ä»–çº¿ç¨‹å¯ä»¥æ›´æ”¹å¯¹è±¡å¤´çš„çŠ¶æ€ã€‚

#### åå‘é”çŠ¶æ€

åœ¨åå‘é”çŠ¶æ€ä¸‹ï¼Œåªæœ‰ç¬¬ä¸€ä¸ªè®¿é—®å…±äº«èµ„æºçš„çº¿ç¨‹å¯ä»¥æˆåŠŸèŽ·å–é”ï¼Œå…¶ä»–çº¿ç¨‹ä¼šè¢«é˜»å¡žã€‚è¿™ç§é”å…·æœ‰è¾ƒé«˜çš„æ€§èƒ½ï¼Œå› ä¸ºå®ƒé¿å…äº†ä¸å¿…è¦çš„é”ç«žäº‰ã€‚åå‘é”ä¼šæ£€æŸ¥Mark Wordä¸­çš„ThreadIdæ˜¯å¦æŒ‡å‘å½“å‰çº¿ç¨‹ï¼Œå¦‚æžœæ˜¯ï¼Œåˆ™æ‰§è¡ŒåŒæ­¥ä»£ç ã€‚å¦‚æžœä¸æ˜¯ï¼Œåˆ™æŸ¥çœ‹å¯¹è±¡æ ‡è®°æ˜¯å¦ä¸ºå¯åå‘ï¼Œå¦‚æžœæ˜¯ï¼Œåˆ™å°è¯•ä½¿ç”¨CASå°†å½“å‰çº¿ç¨‹çš„IDè®°å½•åœ¨å¯¹è±¡å¤´ä¸­ï¼Œå¦‚æžœæˆåŠŸï¼Œåˆ™æ‰§è¡ŒåŒæ­¥ä»£ç ã€‚

#### è½»é‡çº§é”çŠ¶æ€

åœ¨è½»é‡çº§é”çŠ¶æ€ä¸‹ï¼Œæ‰€æœ‰å°è¯•è®¿é—®å…±äº«èµ„æºçš„çº¿ç¨‹éƒ½ä¼šè‡ªæ—‹ç­‰å¾…ï¼Œç›´åˆ°é”è¢«é‡Šæ”¾ã€‚è¿™ç§é”åœ¨å¤šçº¿ç¨‹è®¿é—®æ—¶å¯ä»¥å‡å°‘çº¿ç¨‹çš„é˜»å¡žï¼Œæé«˜ç¨‹åºçš„è¿è¡Œæ•ˆçŽ‡ã€‚ç„¶è€Œï¼Œå½“è‡ªæ—‹ç­‰å¾…æ—¶é—´è¶…è¿‡ä¸€å®šé˜ˆå€¼æ—¶ï¼Œè½»é‡çº§é”ä¼šå‡çº§ä¸ºé‡é‡çº§é”ï¼Œæ­¤æ—¶é”çš„ç«žäº‰ç¨‹åº¦ä¼šå˜å¾—æ›´é«˜ï¼Œæ€§èƒ½å¼€é”€ä¹Ÿä¼šç›¸åº”å¢žåŠ ã€‚

å½“æœ‰å…¶ä»–çº¿ç¨‹å°è¯•èŽ·å–åŒä¸€å¯¹è±¡é”ï¼Œæ­¤æ—¶Mark Wordå¤åˆ¶åˆ°æ–°å»ºçš„æ ˆå¸§ä½œä¸ºDisplaced Mark Wordï¼ŒåŒæ—¶ä½¿ç”¨CASå°†å¯¹è±¡å¤´éƒ¨çš„Mark Wordæ›¿æ¢ä¸ºæŒ‡å‘è½»é‡çº§é”çš„æŒ‡é’ˆï¼Œå¦‚æžœæˆåŠŸï¼Œåˆ™èŽ·å–é”ï¼Œå¦‚æžœå¤±è´¥ï¼Œåˆ™è‡ªæ—‹ã€‚

#### é‡é‡çº§é”çŠ¶æ€

åœ¨é‡é‡çº§é”çŠ¶æ€ä¸‹ï¼Œçº¿ç¨‹ä¼šè¢«é˜»å¡žï¼Œç›´åˆ°é”è¢«é‡Šæ”¾ã€‚è¿™ç§é”åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹èƒ½å¤Ÿæœ‰æ•ˆåœ°é˜²æ­¢èµ„æºçš„ç«žäº‰ï¼Œä½†æ€§èƒ½å¼€é”€ç›¸å¯¹è¾ƒå¤§ã€‚å½“é”è†¨èƒ€ä¸ºé‡é‡çº§é”æ—¶ï¼Œçº¿ç¨‹ä¼šè¿›å…¥é˜»å¡žçŠ¶æ€ï¼Œå³å°†è‡ªå·±åŠ å…¥åˆ°é”çš„ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œå¹¶é‡Šæ”¾CPUèµ„æºã€‚

## **Synchronized VS JMM**

Java åŒæ­¥é”çš„åº•å±‚å®žçŽ°ä¸»è¦ä¾èµ–äºŽ Java å†…å­˜æ¨¡åž‹ï¼ˆJMMï¼‰ä¸­çš„ä¸»å†…å­˜å’Œå·¥ä½œå†…å­˜ã€‚ä¸»å†…å­˜ä¸­å­˜å‚¨äº†å…±äº«å˜é‡å’Œé”çš„çŠ¶æ€ï¼Œè€Œå·¥ä½œå†…å­˜ä¸­å­˜å‚¨äº†çº¿ç¨‹çš„å±€éƒ¨å˜é‡ã€‚å½“çº¿ç¨‹è¦è®¿é—®å…±äº«å˜é‡æ—¶ï¼Œä¼šé¦–å…ˆä»Žä¸»å†…å­˜ä¸­èŽ·å–å…±äº«å˜é‡çš„å‰¯æœ¬ï¼Œç„¶åŽåœ¨è‡ªå·±çš„å·¥ä½œå†…å­˜ä¸­è¿›è¡Œæ“ä½œã€‚å¦‚æžœå¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®åŒä¸€ä¸ªå…±äº«å˜é‡ï¼Œé‚£ä¹ˆä¼šé€šè¿‡é”æœºåˆ¶æ¥ä¿è¯äº’æ–¥è®¿é—®ã€‚

## å…¶ä»–åŒæ­¥è§£å†³æ–¹æ¡ˆ

### ReentrantLock

ReentrantLock æ˜¯ä¸€ç§ **å¯é‡å…¥é”**ï¼Œå®ƒä¸Ž Synchronized å…³é”®å­—ç›¸æ¯”ï¼Œæä¾›äº†æ›´å¤šçš„çµæ´»æ€§ï¼Œæ¯”å¦‚å¯ä»¥æ˜¾å¼åœ°èŽ·å–å’Œé‡Šæ”¾é”ã€‚ReentrantLock è¿˜æ”¯æŒ **å…¬å¹³é”å’Œéžå…¬å¹³é”** ä¸¤ç§æ¨¡å¼ï¼Œè¿™ä½¿å¾—å®ƒåœ¨æŸäº›åœºæ™¯ä¸‹æ¯” Synchronized å…³é”®å­—æ›´å…·ä¼˜åŠ¿ã€‚ä½†æ˜¯ï¼ŒReentrantLock çš„æ€§èƒ½å¯èƒ½ä¸å¦‚ Synchronized å…³é”®å­—ï¼Œå› ä¸ºå®ƒéœ€è¦ç»´æŠ¤ä¸€ä¸ªé”å¯¹è±¡ã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ªä½¿ç”¨ ReentrantLock çš„ç¤ºä¾‹ï¼š

```java
import java.util.concurrent.locks.ReentrantLock;
public class ReentrantLockExample {
   private final ReentrantLock lock = new ReentrantLock();
   private int counter = 0;

   public void incrementCounter() {
        lock.lock(); // èŽ·å–é”
        try {
            counter++; // æ‰§è¡Œä¸´ç•ŒåŒºä»£ç 
            System.out.println("Counter: " + counter);
        } finally {
            lock.unlock(); // é‡Šæ”¾é”
        }
    }

    public static void main(String[] args) {
        ReentrantLockExample example = new ReentrantLockExample();
        // åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹æ¥è®¿é—®å…±äº«èµ„æº
        Thread t1 = new Thread(() -> {
            for (int i = 0; i < 10; i++) {
                example.incrementCounter();
            }
        });
        Thread t2 = new Thread(() -> {
            for (int i = 0; i < 10; i++) {
                example.incrementCounter();
            }
        });
        // å¯åŠ¨çº¿ç¨‹
        t1.start();
        t2.start();
        // ç­‰å¾…çº¿ç¨‹æ‰§è¡Œå®Œæ¯•
        try {
            t1.join();
            t2.join();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println("Final Counter: " + example.counter);
    }
}

```

åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† ReentrantLock æ¥ä¿æŠ¤Â `counter`Â å˜é‡ã€‚é€šè¿‡ä½¿ç”¨Â `lock()`Â å’ŒÂ `unlock()`Â æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥æ˜¾å¼åœ°èŽ·å–å’Œé‡Šæ”¾é”ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜çœ‹åˆ° ReentrantLock æ”¯æŒå…¬å¹³é”å’Œéžå…¬å¹³é”ä¸¤ç§æ¨¡å¼ï¼Œè¿™å¯ä»¥é€šè¿‡æž„é€ å‡½æ•°å‚æ•°è¿›è¡Œè®¾ç½®ã€‚

### ReadWriteLock

ReadWriteLock æ˜¯ä¸€ç§è¯»å†™é”ï¼Œå®ƒå¯ä»¥åŒæ—¶å…è®¸å¤šä¸ªçº¿ç¨‹è¯»å–å…±äº«èµ„æºï¼Œä½†æ˜¯åªå…è®¸ä¸€ä¸ªçº¿ç¨‹å†™å…¥å…±äº«èµ„æºã€‚ **ä¸ŽSynchronized å…³é”®å­—ç›¸æ¯”ï¼ŒReadWriteLock æä¾›äº†æ›´å¥½çš„è¯»æ€§èƒ½ï¼Œä½†æ˜¯å†™æ€§èƒ½å¯èƒ½è¾ƒå·®ã€‚**

ä»¥ä¸‹æ˜¯ä¸€ä¸ªä½¿ç”¨ ReadWriteLock çš„ç¤ºä¾‹ï¼š

```java
import java.util.concurrent.locks.ReadWriteLock;
import java.util.concurrent.locks.ReentrantReadWriteLock;
public class ReadWriteLockExample {
    private final ReadWriteLock lock = new ReentrantReadWriteLock();
    private int counter = 0;

    public void incrementCounter() {
        lock.writeLock().lock(); // èŽ·å–å†™é”
        try {
            counter++; // æ‰§è¡Œä¸´ç•ŒåŒºä»£ç 
            System.out.println("Counter: " + counter);
        } finally {
            lock.writeLock().unlock(); // é‡Šæ”¾å†™é”
        }
    }
    public void readCounter() {
        lock.readLock().lock(); // èŽ·å–è¯»é”
        try {
            System.out.println("Counter: " + counter);
        } finally {
            lock.readLock().unlock(); // é‡Šæ”¾è¯»é”
        }
    }

    public static void main(String[] args) {
        ReadWriteLockExample example = new ReadWriteLockExample();
        // åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªç”¨äºŽå†™å…¥ï¼Œä¸€ä¸ªç”¨äºŽè¯»å–
        Thread t1 = new Thread(() -> {
            for (int i = 0; i < 10; i++) {
                example.incrementCounter();
            }
        });
        Thread t2 = new Thread(() -> {
            for (int i = 0; i < 10; i++) {
                example.readCounter();
            }
        });
        // å¯åŠ¨çº¿ç¨‹
        t1.start();
        t2.start();
        // ç­‰å¾…çº¿ç¨‹æ‰§è¡Œå®Œæ¯•
        try {
         t1.join();
         t2.join();
        } catch (InterruptedException e) {
          e.printStackTrace();
       }
       System.out.println("Final Counter: " + example.counter);
    }
}

```

åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† ReentrantReadWriteLock ä½œä¸ºè¯»å†™é”ã€‚ä¸Ž ReentrantLock ç±»ä¼¼ï¼ŒReentrantReadWriteLock ä¹Ÿæ”¯æŒå…¬å¹³é”å’Œéžå…¬å¹³é”ä¸¤ç§æ¨¡å¼ã€‚é€šè¿‡ä½¿ç”¨Â `writeLock()`Â å’ŒÂ `readLock()`Â æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥èŽ·å–å’Œé‡Šæ”¾å†™é”å’Œè¯»é”ã€‚è¿™æ ·ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹éœ€è¦å†™å…¥å…±äº«èµ„æºæ—¶ï¼Œå®ƒå¯ä»¥èŽ·å–å†™é”ï¼›å½“ä¸€ä¸ªçº¿ç¨‹éœ€è¦è¯»å–å…±äº«èµ„æºæ—¶ï¼Œå®ƒå¯ä»¥èŽ·å–è¯»é”ã€‚è¿™ç§è®¾è®¡ä½¿å¾—åœ¨è¯»æ“ä½œè¿œå¤šäºŽå†™æ“ä½œçš„åœºæ™¯ä¸‹ï¼ŒReadWriteLock èƒ½å¤Ÿæé«˜ç¨‹åºçš„å¹¶å‘æ€§èƒ½ã€‚

åœ¨å®žé™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®å…·ä½“çš„ä¸šåŠ¡åœºæ™¯é€‰æ‹©åˆé€‚çš„åŒæ­¥è§£å†³æ–¹æ¡ˆï¼Œä»¥å®žçŽ°æ›´é«˜çš„ç¨‹åºæ€§èƒ½ã€‚

![](images/719091/5fe9fe18b58a610cc32a2bb224935bf3.jpg)

## åœ¨ JDK æºç ä¸­çš„åº”ç”¨

åœ¨JDKã€Apacheç­‰å¼€æºé¡¹ç›®ï¼Œä¹ƒè‡³å¤§éƒ¨åˆ†çš„ Java å¼€æºé¡¹ç›®ä¸­ï¼Œsynchronized å…³é”®å­—éƒ½ä¼šè¢«å¹¿æ³›åº”ç”¨ã€‚åœ¨ JDK ä¸­çš„ç»å…¸åº”ç”¨å°±æ˜¯ StringBuffer å’Œ Vector å¯¹è±¡ï¼Œè¿™ä¸¤ä¸ªå¯¹è±¡çš„æ‰€æœ‰ä¸»è¦æ–¹æ³•éƒ½è¢« synchronized ä¿æŠ¤ï¼Œä»¥å®žçŽ°çº¿ç¨‹å®‰å…¨ã€‚ä»¥ä¸‹æ˜¯ StringBuffer çš„ä¸€ä¸ªç¤ºä¾‹:

```java
public synchronized StringBuffer append(String str) {
toStringCache = null;
super.append(str);
return this;
}

```

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œå½“æŸä¸ªçº¿ç¨‹è¿›å…¥ append æ–¹æ³•æ—¶ï¼Œå®ƒå°†èŽ·å¾— StringBuffer å¯¹è±¡çš„é”ï¼›å…¶ä»–çº¿ç¨‹ï¼Œå¦‚æžœè¦è°ƒç”¨ä»»ä½•å…¶ä»–çš„ synchronized å®žä¾‹æ–¹æ³•ï¼ˆå¦‚ insertã€delete ç­‰ï¼‰ï¼Œéƒ½å¿…é¡»ç­‰å¾…è¿™ä¸ªçº¿ç¨‹é‡Šæ”¾é”èµ„æºã€‚

## æœ€ä½³å®žè·µ

1. å°½é‡å‡å°‘åŒæ­¥èŒƒå›´

åœ¨ç¼–å†™å¤šçº¿ç¨‹ç¨‹åºæ—¶ï¼Œåº”å°½é‡å‡å°‘åŒæ­¥èŒƒå›´ï¼Œåªå¯¹ç¡®å®žéœ€è¦åŒæ­¥çš„ä»£ç è¿›è¡ŒåŒæ­¥ã€‚è¿™æ ·å¯ä»¥å‡å°‘é”çš„ç«žäº‰ï¼Œæé«˜ç¨‹åºçš„æ€§èƒ½ã€‚

1. ä½¿ç”¨é™æ€åŒæ­¥æ–¹æ³•

å¦‚æžœä¸€ä¸ªæ–¹æ³•åªéœ€è¦åŒæ­¥ä¸€æ¬¡ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨é™æ€åŒæ­¥æ–¹æ³•ã€‚é™æ€åŒæ­¥æ–¹æ³•ä¼šåœ¨ç±»åŠ è½½æ—¶èŽ·å–é”ï¼Œé¿å…äº†æ¯æ¬¡è°ƒç”¨æ—¶éƒ½èŽ·å–é”çš„å¼€é”€ã€‚

1. ä½¿ç”¨é”çš„å¯é‡å…¥æ€§

å¦‚æžœä¸€ä¸ªçº¿ç¨‹éœ€è¦å¤šæ¬¡è®¿é—®åŒä¸€ä¸ªåŒæ­¥æ–¹æ³•æˆ–ä»£ç å—ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨é”çš„å¯é‡å…¥æ€§ã€‚è¿™æ ·ï¼Œçº¿ç¨‹åœ¨è®¿é—®å®Œä¸€ä¸ªåŒæ­¥æ–¹æ³•æˆ–ä»£ç å—åŽï¼Œä¸éœ€è¦å†æ¬¡èŽ·å–é”ï¼Œä»Žè€Œå‡å°‘äº†é”çš„ç«žäº‰ã€‚

## é‡ç‚¹å›žé¡¾

Java åŒæ­¥é”æœºåˆ¶æ˜¯ Java å¹¶å‘ç¼–ç¨‹çš„åŸºç¡€ï¼Œå®ƒå¯ä»¥ä¿è¯åœ¨å¤šçº¿ç¨‹çŽ¯å¢ƒä¸‹å¯¹å…±äº«èµ„æºçš„äº’æ–¥è®¿é—®ã€‚Synchronized å…³é”®å­—æ˜¯ Java åŒæ­¥é”æœºåˆ¶çš„æ ¸å¿ƒï¼Œå®ƒé€šè¿‡é”çš„çŠ¶æ€å’Œé”çš„èŽ·å–é‡Šæ”¾æœºåˆ¶ï¼Œå®žçŽ°äº†çº¿ç¨‹ä¹‹é—´çš„åŒæ­¥ã€‚æ­¤å¤–è¿˜æœ‰ä¸¤ç§å¸¸ç”¨çš„åŒæ­¥è§£å†³æ–¹æ¡ˆï¼šReentrantLock å’Œ ReentrantLockï¼Œå®ƒä»¬çš„ç‰¹ç‚¹ä¸ŽèŒèƒ½ä¸åŒï¼Œåœ¨å®žé™…ç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬åº”æ ¹æ®å…·ä½“çš„éœ€æ±‚ï¼Œé€‰æ‹©åˆé€‚çš„åŒæ­¥è§£å†³æ–¹æ¡ˆï¼Œä»¥æé«˜ç¨‹åºçš„æ€§èƒ½ã€‚

## æ€è€ƒé¢˜

å­¦è€Œä¸æ€åˆ™ç½”ï¼Œå­¦å®Œè¿™èŠ‚è¯¾ä¹‹åŽï¼Œæˆ‘ç»™ä½ ç•™ä¸¤ä¸ªé—®é¢˜ã€‚

1. ReentrantLock å’Œ Synchronized æœ‰å“ªäº›ç›¸åŒç‚¹å’Œä¸åŒç‚¹ï¼Ÿ
2. Synchronizedé”çš„çŠ¶æ€æœ‰å“ªäº›ï¼Ÿ

å¸Œæœ›ä½ è®¤çœŸæ€è€ƒï¼Œç„¶åŽæŠŠæ€è€ƒåŽçš„ç»“æžœåˆ†äº«åˆ°è¯„è®ºåŒºï¼Œæˆ‘ä»¬ä¸€èµ·è®¨è®ºï¼Œå¦‚æžœæœ‰æ”¶èŽ·çš„è¯ï¼Œä¹Ÿæ¬¢è¿Žä½ æŠŠè¿™èŠ‚è¯¾çš„å†…å®¹åˆ†äº«ç»™éœ€è¦çš„æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼

ðŸ’¡ ç‚¹äº®ä½ çš„çŸ¥è¯†æ¡†æž¶å›¾

![](images/719091/3f17934487fbaa099a74109908b0bc39.jpg)